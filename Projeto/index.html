<!DOCTYPE html>

<html lang="en">
  <!--

		threejs_ex_01_01_basic_skeleton.html

		The basic structure of a Three.js example file

		J. Madeira - March 2021 - Updated: April 2023

		Adapted / simplified from 

		https://github.com/mrdoob/three.js/blob/master/examples/webgl_geometry_cube.html

-->

  <head>
    <title>three.js example 01 &mdash; Basic skeleton</title>

    <meta charset="utf-8" />

    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <style>
      body {
        background-color: cyan;

        /* To use the complete page */

        margin: 0px;

        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <div id="WebGL-output"></div>

    <script
      async
      src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://threejs.org/build/three.module.js",
          "three/addons/": "https://threejs.org/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";

      let objects = [];

      function init() {
        var camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          1,
          1000
        );

        var yHeight = 6;
        camera.position.set(0, yHeight, 15);
        camera.lookAt(0, yHeight, 0);

        let scene = new THREE.Scene();

        let light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
        light.position.set(0.5, 1, 0.75);
        scene.add(light);

        let renderer = new THREE.WebGLRenderer();

        document
          .getElementById("WebGL-output")
          .appendChild(renderer.domElement);

        let controls = new PointerLockControls(camera, renderer.domElement);

        let geometry = new THREE.PlaneGeometry(2000, 2000, 100, 100);
        let material = new THREE.MeshLambertMaterial({
          color: 0xffffff,
          wireframe: true,
        });

        let plane = new THREE.Mesh(geometry, material);
        plane.rotation.x = -Math.PI / 2;
        scene.add(plane);
        objects.push(plane);

        renderer.setClearColor(0xffffff);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document
          .getElementById("WebGL-output")
          .appendChild(renderer.domElement);

        // camera
        controls.addEventListener("lock", function () {
          menu.style.display = "none";
        });

        controls.addEventListener("unlock", function () {
          menu.style.display = "block";
        });
        // movement
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let canJump = false;

        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let vertex = new THREE.Vector3();
        let color = new THREE.Color();

        document.addEventListener(
          "keydown",
          function (event) {
            switch (event.keyCode) {
              case 38: // up
              case 87: // w
                moveForward = true;
                break;
              case 37: // left
              case 65: // a
                moveLeft = true;
                break;
              case 40: // down
              case 83: // s
                moveBackward = true;
                break;
              case 39: // right
              case 68: // d
                moveRight = true;
                break;
              case 32: // space
                if (canJump === true) velocity.y += 200;
                canJump = false;
                break;
            }
          },
          false
        );

        document.addEventListener(
          "keyup",
          function (event) {
            switch (event.keyCode) {
              case 38: // up
              case 87: // w
                moveForward = false;
                break;
              case 37: // left
              case 65: // a
                moveLeft = false;
                break;
              case 40: // down
              case 83: // s
                moveBackward = false;
                break;
              case 39: // right
              case 68: // d
                moveRight = false;
                break;
            }
          },
          false
        );

        function animate() {
          let time = performance.now();
          let delta = (time - prevTime) / 1000;

          if (velocity.y == 0) {
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;
            if (moveForward || moveBackward)
              velocity.z -= direction.z * 1000.0 * delta;
            if (moveLeft || moveRight)
              velocity.x -= direction.x * 1000.0 * delta;
          }

          velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

          direction.z = Number(moveForward) - Number(moveBackward);
          direction.x = Number(moveRight) - Number(moveLeft);

          controls.moveRight(-velocity.x * delta);
          controls.moveForward(-velocity.z * delta);

          controls.getObject().position.y += velocity.y * delta; // new behavior

          if (controls.getObject().position.y < yHeight) {
            velocity.y = 0;
            controls.getObject().position.y = yHeight;
            canJump = true;
          }

          prevTime = time;

          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        }

        animate();
      }

      init();

      window.onload = init;
    </script>
  </body>
</html>
